name: CI/CD Pipeline
on:
  push:
    branches:
    - main
jobs:
  checkoutCode:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        repository: DaggupatiPavan/java-web-app-docker
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
  createAnEc2Instance:
    runs-on: ubntu-latest
    steps:
    - name: action download
      uses: action/download-artifact@v3
      with:
        name: build
        path: dist
    - name: Create an EC2 Instance
      run: '#!/bin/bash

        terraform init

        terraform validate

        terraform plan

        terraform apply --auto-approve'
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
  installK8sAndDocker:
    runs-on: ubntu-latest
    steps:
    - name: action download
      uses: action/download-artifact@v3
      with:
        name: build
        path: dist
    - name: Install K8s and Docker
      run: "#!/bin/bash\nIP_ADDRESSES=$(terraform output instance_ip | jq -r)\n  \
        \                      > myinventory\n                        echo \"auctane\
        \ ansible_ssh_host=ubuntu@${IP_ADDRESSES}\" >> myinventory\n             \
        \           cat myinventory\nansible-playbook -i myinventory ks8_install.yaml\n\
        \                    ansible-playbook -i myinventory docker.yaml"
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
  buildDockerImage:
    runs-on: ubntu-latest
    steps:
    - name: action download
      uses: action/download-artifact@v3
      with:
        name: build
        path: dist
    - name: Build Docker Image
      run: '#!/bin/bash

        docker build -t 10.63.16.153:32003/ubiq:${BUILD_NUMBER} .'
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
  logInToDockerHub:
    runs-on: ubntu-latest
    steps:
    - name: action download
      uses: action/download-artifact@v3
      with:
        name: build
        path: dist
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
  pushDockerImage:
    runs-on: ubntu-latest
    steps:
    - name: action download
      uses: action/download-artifact@v3
      with:
        name: build
        path: dist
    - name: Push Docker Image
      run: '#!/bin/bash

        docker push 10.63.16.153:32003/ubiq:${BUILD_NUMBER}'
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
  deployToKubernetes:
    runs-on: ubntu-latest
    steps:
    - name: action download
      uses: action/download-artifact@v3
      with:
        name: build
        path: dist
    - name: Deploy to Kubernetes
      run: "#!/bin/bash\nIP_ADDRESSES=$(terraform output instance_ip | jq -r)\n  \
        \                  ansible-playbook -i myinventory deploy.yaml\n         \
        \           ssh ubuntu@${IP_ADDRESSES} \"kubectl create secret docker-registry\
        \ regcred --docker-server=http://10.63.12.180:32003 --docker-username=admin\
        \ --docker-password=admin\"\n                    ssh ubuntu@${IP_ADDRESSES}\
        \ \"kubectl apply -f pod.yaml\"\n                    ssh ubuntu@${IP_ADDRESSES}\
        \ \"kubectl expose pod ubiq --type=NodePort --port=80\"\nIP_ADDRESSES=$(terraform\
        \ output instance_ip | jq -r)\n                    ssh ubuntu@${IP_ADDRESSES}\
        \ \"kubectl get pods -A\"\n                    ssh ubuntu@${IP_ADDRESSES}\
        \ \"kubectl get svc -A\""
    - name: action upload
      uses: action/upload-artifact@v3
      with:
        name: build
        path: dist
